version: '3.8'

# ============================================================================
# Docker Compose - FlightOnTime Application
# ============================================================================
# Orquestração completa da aplicação:
# - Backend Java (Spring Boot)
# - API Python (FastAPI + ML)
# - Network bridge para comunicação entre serviços
# ============================================================================

services:
  # ==========================================================================
  # API Python - Data Science (FastAPI + Machine Learning)
  # ==========================================================================
  python-api:
    build:
      context: .
      dockerfile: data_science/semana_04/scripts/Dockerfile
    container_name: flightontime-python
    image: flightontime-python:latest

    command: uvicorn api_app:app --host 0.0.0.0 --port 5000

    ports:
      - "5000:5000"

    environment:
      - PYTHONUNBUFFERED=1
      - PORT=5000

    volumes:
      # Mount para desenvolvimento (hot reload)
      # Comentar em produção
      - ./data_science/semana_04/scripts:/app:ro

    networks:
      - flightontime-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    restart: unless-stopped

    labels:
      - "com.flightontime.service=python-api"
      - "com.flightontime.team=datascience"

  # ==========================================================================
  # Backend Java - Spring Boot API
  # ==========================================================================
  java-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flightontime-backend
    image: flightontime-backend:latest

    ports:
      - "8080:8080"

    environment:
      - JAVA_OPTS=-Xmx512m -Xms256m -XX:+UseContainerSupport
      - SERVER_PORT=8080
      - PREDICTION_SERVICE_URL=http://python-api:5000
      - PREDICTION_SERVICE_USE_MOCK=false
      - SPRING_PROFILES_ACTIVE=docker
      - TZ=America/Sao_Paulo

    depends_on:
      python-api:
        condition: service_healthy

    networks:
      - flightontime-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

    labels:
      - "com.flightontime.service=java-backend"
      - "com.flightontime.team=backend"

# ============================================================================
# Networks
# ============================================================================
networks:
  flightontime-network:
    driver: bridge
    name: flightontime-network

# ============================================================================
# Volumes (opcional - para persistência de dados)
# ============================================================================
volumes:
  app-logs:
    driver: local

# ============================================================================
# Como usar:
# ============================================================================
#
# Iniciar todos os serviços:
#   docker-compose up -d
#
# Ver logs:
#   docker-compose logs -f
#   docker-compose logs -f java-backend
#   docker-compose logs -f python-api
#
# Parar serviços:
#   docker-compose stop
#
# Parar e remover containers:
#   docker-compose down
#
# Rebuild de imagens:
#   docker-compose build
#   docker-compose up -d --build
#
# Verificar status:
#   docker-compose ps
#
# Acessar aplicação:
#   Backend Java: http://localhost:8080
#   API Python: http://localhost:5000
#   Swagger Java: http://localhost:8080/swagger-ui.html
#   Docs Python: http://localhost:5000/docs
#
# Testar health checks:
#   curl http://localhost:8080/api/health
#   curl http://localhost:5000/health
#
# Testar predição:
#   curl -X POST http://localhost:8080/api/predict \
#     -H "Content-Type: application/json" \
#     -d '{
#       "companhia": "AZ",
#       "origem": "GIG",
#       "destino": "GRU",
#       "data_partida": "2025-12-25T14:30:00",
#       "distancia_km": 350
#     }'
#
# ============================================================================
